<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Tareas</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="container">

    <!-- HEADER -->
    <div class="header">
        <div class="header-content">
            <svg class="icon-header" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 5h6m-6 4h6m-7 4h8m-9 4h10"></path>
            </svg>
            <h1>Gesti√≥n de Tareas</h1>
        </div>
        <p class="subtitle">Aqu√≠ puedes administrar tus tareas</p>
    </div>

    <!-- LISTA DE TAREAS -->
    <div class="card">
        <div class="list-header">
            <h2>Tareas</h2>
        </div>

        <div id="mensaje" class="empty-state"></div>
        <div id="listaTareas"></div>
    </div>

    <!-- LOGOUT -->
    <div class="card">
        <button id="logout" class="btn-secondary">Cerrar sesi√≥n</button>
    </div>

</div>

<script>
const listaTareas = document.getElementById('listaTareas');
const mensaje = document.getElementById('mensaje');
const logoutBtn = document.getElementById('logout');

let tareas = [];
const token = localStorage.getItem('token');

// ==============================
// FUNCIONES BACKEND
// ==============================
async function cargarTareas() {
    try {
        const res = await fetch('/api/tareas', {
            headers: { 'Authorization': `Bearer ${token || ''}` }
        });
        if (res.status === 401) throw new Error('No autorizado');
        tareas = await res.json();
        render();
    } catch (err) {
        alert('Tu sesi√≥n expir√≥ o no tienes permisos');
        localStorage.removeItem('token');
        window.location.href = '/index.html';
    }
}

async function completarTarea(id) {
    const tarea = tareas.find(t => t.id === id);
    if (!tarea) return;
    tarea.estado = 'completada';
    await actualizarTarea(tarea);
}

async function eliminarTarea(id) {
    try {
        const res = await fetch(`/api/tareas/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token || ''}` }
        });
        if (res.status === 401) throw new Error('No autorizado');
        tareas = tareas.filter(t => t.id !== id);
        render();
    } catch (err) {
        alert('Tu sesi√≥n expir√≥ o no tienes permisos');
        localStorage.removeItem('token');
        window.location.href = '/index.html';
    }
}

async function actualizarTarea(tarea) {
    try {
        const res = await fetch(`/api/tareas/${tarea.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token || ''}`
            },
            body: JSON.stringify(tarea)
        });
        if (res.status === 401) throw new Error('No autorizado');
        render();
    } catch (err) {
        alert('Tu sesi√≥n expir√≥ o no tienes permisos');
        localStorage.removeItem('token');
        window.location.href = '/index.html';
    }
}

// ==============================
// RENDER
// ==============================
function render() {
    listaTareas.innerHTML = '';
    mensaje.innerHTML = '';

    if (tareas.length === 0) {
        mensaje.innerHTML = `
            <p>No hay tareas registradas</p>
            <p>Agrega tareas desde la pantalla principal</p>
        `;
        return;
    }

    tareas.forEach(t => {
        const item = document.createElement('div');
        item.className = 'download-item';

        item.innerHTML = `
            <div class="download-content">
                <div class="download-info">
                    <div class="download-header">
                        <div class="status-icon ${t.estado === 'completada' ? 'status-completada' : 'status-descargando'}">‚úî</div>
                        <div class="download-title-section">
                            <div class="download-title">${t.nombre}</div>
                            <div class="download-size">Asignado a: ${t.asignadoA}</div>
                        </div>
                        <span class="status-badge ${t.estado === 'completada' ? 'badge-green' : 'badge-blue'}">${t.estado}</span>
                    </div>
                    <div class="download-meta">
                        <div class="meta-item"><span class="label">Fecha:</span> ${t.fechaCreacion}</div>
                    </div>
                </div>
                <div class="download-actions">
                    <button class="action-btn action-btn-indigo" onclick="editar('${t.id}')">‚úèÔ∏è</button>
                    <button class="action-btn action-btn-green" onclick="completar('${t.id}')">‚úÖ</button>
                    <button class="action-btn action-btn-red" onclick="eliminar('${t.id}')">üóë</button>
                </div>
            </div>
        `;
        listaTareas.appendChild(item);
    });
}

// ==============================
// ACCIONES
// ==============================
async function completar(id) {
    await completarTarea(id);
}

async function eliminar(id) {
    await eliminarTarea(id);
}

async function editar(id) {
    const tarea = tareas.find(t => t.id === id);
    if (!tarea) return;
    const nuevoNombre = prompt('Nuevo nombre de la tarea', tarea.nombre);
    if (nuevoNombre) {
        tarea.nombre = nuevoNombre;
        await actualizarTarea(tarea);
    }
}

// ==============================
// LOGOUT
// ==============================
logoutBtn.addEventListener('click', () => {
    localStorage.removeItem('token');
    window.location.href = '/index.html';
});

// ==============================
// INIT
// ==============================
cargarTareas();
</script>

</body>
</html>
